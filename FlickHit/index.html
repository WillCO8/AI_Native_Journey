<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FlickHit üéµüì∏</title>
  <style>
    body {
      font-family: 'Inter', sans-serif; /* Using Inter font */
      text-align: center;
      padding: 20px;
      background: linear-gradient(to bottom right, #e0f7fa, #bbdefb); /* Light gradient background */
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #333;
    }
    h1 {
      font-size: 2.8em;
      color: #2c3e50;
      margin-bottom: 15px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    .tagline {
      font-size: 1.2em;
      color: #555;
      margin-bottom: 30px;
    }
    #dropzone {
      border: 3px dashed #3498db;
      background-color: #ffffff;
      padding: 50px;
      margin: 30px auto;
      width: 90%; /* Responsive width */
      max-width: 500px; /* Max width for desktop */
      cursor: pointer;
      border-radius: 15px; /* More rounded corners */
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 1.1em;
      color: #3498db;
      font-weight: bold;
    }
    #dropzone:hover {
      background-color: #eef7ff;
      border-color: #2980b9;
      transform: translateY(-2px);
    }
    #preview img {
      display: block;
      margin: 30px auto;
      max-width: 90%; /* Responsive image width */
      height: auto; /* Maintain aspect ratio */
      border-radius: 15px; /* More rounded corners */
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      border: 4px solid #fff; /* White border around image */
    }
    .result {
      margin-top: 25px;
      font-size: 1.3em;
      color: #2c3e50;
      background-color: #ffffff;
      padding: 20px 30px;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
      max-width: 600px;
      width: 90%;
      line-height: 1.6;
    }
    .result strong {
      color: #e74c3c; /* Highlight important text */
    }
    .result a {
      color: #3498db;
      text-decoration: none;
      font-weight: bold;
      transition: color 0.2s ease;
    }
    .result a:hover {
      color: #2980b9;
      text-decoration: underline;
    }
    .info-message {
        background-color: #d9edf7;
        color: #31708f;
        padding: 10px 20px;
        border-radius: 10px;
        margin-top: 20px;
        font-size: 0.9em;
        max-width: 600px;
        width: 90%;
    }
    /* Responsive adjustments */
    @media (max-width: 600px) {
      h1 {
        font-size: 2em;
      }
      .tagline {
        font-size: 1em;
      }
      #dropzone {
        padding: 30px;
        width: 95%;
      }
      .result {
        font-size: 1em;
        padding: 15px;
        width: 95%;
      }
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
  <h1>FlickHit üéµüì∏</h1>
  <p class="tagline">Hear the Moment: Your Photo's #1 Hit</p>
  <div class="info-message">FlickHit temporarily reads only the date from your photo's metadata to find related cultural data. Your photo file is never stored.</div>
  <div id="dropzone">üì∏ Click to upload or drag your photo here</div>
  <div id="preview"></div>
  <div class="result" id="result">Upload a photo to begin...</div>

  <!-- Load exifr library for EXIF data parsing -->
  <script src="https://cdn.jsdelivr.net/npm/exifr/dist/lite.umd.js"></script>

  <script>
    const dropzone = document.getElementById("dropzone");
    const resultDiv = document.getElementById("result");
    const preview = document.getElementById("preview");

    // The raw URL for your JSON data on GitHub
    const CHART_DATA_URL = "https://raw.githubusercontent.com/WillCO8/AI_Native_Journey/refs/heads/main/FlickHit/chart_1980_2025_full.json";
    let chartData = null; // To store the fetched JSON data

    // Function to fetch the JSON data once
    async function loadChartData() {
      if (chartData) return; // Already loaded

      resultDiv.textContent = "Loading song data...";
      try {
        const response = await fetch(CHART_DATA_URL);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        chartData = await response.json();
        resultDiv.textContent = "Upload a photo to begin..."; // Reset message after loading
      } catch (error) {
        resultDiv.textContent = "Error loading song data. Please try again later.";
        console.error("Error fetching chart data:", error);
      }
    }

    async function handleFile(file) {
      if (!chartData) {
        resultDiv.textContent = "Still loading song data. Please wait...";
        await loadChartData(); // Try to load if not already
        if (!chartData) { // If still null after attempting to load
            resultDiv.textContent = "Failed to load song data. Cannot process photo.";
            return;
        }
      }

      resultDiv.innerHTML = "Reading photo data...";
      preview.innerHTML = ""; // Clear previous image

      const img = document.createElement("img");
      img.src = URL.createObjectURL(file);
      img.alt = "Uploaded photo";
      preview.appendChild(img);

      try {
        const exifData = await exifr.parse(file);
        const date = exifData?.DateTimeOriginal || exifData?.CreateDate;

        if (!date) {
          resultDiv.innerHTML = "<strong>No date information found in this photo.</strong><br>Please upload a photo with EXIF 'DateTimeOriginal' metadata.";
          return;
        }

        const photoDate = new Date(date);
        // Calculate the Saturday of the week the photo was taken
        // getDay() returns 0 for Sunday, 6 for Saturday
        const dayOfWeek = photoDate.getDay();
        const daysSinceSaturday = (dayOfWeek + 1) % 7; // Days passed since last Saturday (0 for Saturday, 1 for Sunday, ..., 6 for Friday)
        const saturdayDate = new Date(photoDate);
        saturdayDate.setDate(photoDate.getDate() - daysSinceSaturday);

        const year = saturdayDate.getFullYear();
        const month = String(saturdayDate.getMonth() + 1).padStart(2, '0');
        const day = String(saturdayDate.getDate()).padStart(2, '0');
        const weekKey = `${year}-${month}-${day}`;

        // Access the song data directly using the weekKey
        const entry = chartData[weekKey];

        if (entry) {
          resultDiv.innerHTML = `
            <strong>üóìÔ∏è Taken On: ${photoDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</strong><br>
            <br>
            <strong>üé∂ The #1 Hit from that week was:</strong><br>
            <strong>"${entry.title}"</strong> by ${entry.artist}<br>
            <br>
            <a href="${entry.youtube}" target="_blank" style="display:inline-block; margin-top:10px; padding: 8px 15px; background-color: #e74c3c; color: white; border-radius: 8px; text-decoration: none; font-size: 0.9em;">‚ñ∂Ô∏è Watch on YouTube</a>
            <a href="https://www.billboard.com/charts/hot-100/${weekKey}" target="_blank" style="display:inline-block; margin-top:10px; margin-left: 10px; padding: 8px 15px; background-color: #3498db; color: white; border-radius: 8px; text-decoration: none; font-size: 0.9em;">üìà View Billboard Chart</a>
          `;
        } else {
          resultDiv.innerHTML = `
            <strong>üóìÔ∏è Taken On: ${photoDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</strong><br>
            <br>
            No #1 song found in our database for the week of ${weekKey}.<br>
            <a href="https://www.billboard.com/charts/hot-100/${weekKey}" target="_blank" style="display:inline-block; margin-top:10px; padding: 8px 15px; background-color: #3498db; color: white; border-radius: 8px; text-decoration: none; font-size: 0.9em;">üìà View Billboard Chart for this date</a>
          `;
        }
      } catch (error) {
        resultDiv.innerHTML = "<strong>Error processing photo.</strong><br>Please ensure it's a valid image file with readable EXIF data.";
        console.error("Error in handleFile:", error);
      } finally {
        // Revoke the object URL to free up memory
        if (img.src && img.src.startsWith('blob:')) {
            URL.revokeObjectURL(img.src);
        }
      }
    }

    // Event listeners for file upload
    dropzone.addEventListener("click", () => {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "image/*";
      input.onchange = () => {
        if (input.files.length > 0) {
          handleFile(input.files[0]);
        }
      };
      input.click();
    });

    dropzone.addEventListener("dragover", e => {
      e.preventDefault();
      dropzone.style.backgroundColor = "#d0f0ff";
    });

    dropzone.addEventListener("dragleave", () => {
      dropzone.style.backgroundColor = "#ffffff";
    });

    dropzone.addEventListener("drop", e => {
      e.preventDefault();
      dropzone.style.backgroundColor = "#ffffff";
      const file = e.dataTransfer.files[0];
      if (file) {
        handleFile(file);
      }
    });

    // Load chart data as soon as the page loads
    document.addEventListener('DOMContentLoaded', loadChartData);
  </script>
</body>
</html>
