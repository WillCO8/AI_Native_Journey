<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FlickHit ‚Äì Hear the Moment</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 30px;
      background: #f9f9f9;
    }
    h1 {
      font-size: 2em;
    }
    input {
      margin: 20px 0;
    }
    #result {
      margin-top: 20px;
    }
    img {
      max-width: 300px;
      margin-top: 10px;
    }
    .link {
      margin-top: 10px;
      display: block;
    }
  </style>
</head>
<body>
  <h1>üéµ FlickHit</h1>
  <p><em>Hear the Moment. FlickHit the Memory.</em></p>

  <input type="file" id="photoInput" accept="image/*" />
  <div id="result"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
  <script>
    async function loadSongData() {
      const res = await fetch('chart_1980_2025_sample.json');
      return await res.json();
    }

    function formatDateToWeek(date) {
      const dt = new Date(date);
      dt.setDate(dt.getDate() - dt.getDay()); // Start of the week (Sunday)
      return dt.toISOString().split('T')[0];
    }

    function getExifDate(file, callback) {
      const reader = new FileReader();
      reader.onload = function (e) {
        const view = new DataView(e.target.result);
        EXIF.getData({ src: e.target.result, buffer: view }, function () {
          const date = EXIF.getTag(this, 'DateTimeOriginal');
          callback(date);
        });
      };
      reader.readAsArrayBuffer(file);
    }

    function parseExifDate(exifDate) {
      if (!exifDate) return null;
      const [datePart] = exifDate.split(' ');
      const [year, month, day] = datePart.split(':');
      return `${year}-${month}-${day}`;
    }

    document.getElementById('photoInput').addEventListener('change', async function () {
      const file = this.files[0];
      if (!file) return;

      const resultEl = document.getElementById('result');
      resultEl.innerHTML = 'Reading photo metadata...';

      getExifDate(file, async function (exifDateRaw) {
        const photoDate = parseExifDate(exifDateRaw);
        if (!photoDate) {
          resultEl.innerHTML = 'No date found in photo metadata.';
          return;
        }

        resultEl.innerHTML = `üìÖ Photo taken on: <strong>${photoDate}</strong><br/>Finding #1 song of that week...`;

        const songData = await loadSongData();
        const week = formatDateToWeek(photoDate);
        const entry = songData.find(item => item.date === week);

        if (entry) {
          resultEl.innerHTML += `
            <p>üé∂ <strong>${entry.title}</strong> by <strong>${entry.artist}</strong> was #1 that week.</p>
            <a class="link" href="https://www.youtube.com/results?search_query=${encodeURIComponent(entry.title + ' ' + entry.artist)}" target="_blank">‚ñ∂Ô∏è Listen on YouTube</a>
          `;
        } else {
          resultEl.innerHTML += `<p>Sorry, no song data found for that week (${week}).</p>`;
        }
      });
    });
  </script>
</body>
</html>